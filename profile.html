<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">Editar Perfil</div>
    </header>

    <main class="dashboard">
        <section class="profile-section">
            <h2>Editar Perfil</h2>
            <label for="display-name">Nombre de Usuario:</label>
            <input type="text" id="display-name" placeholder="Nuevo nombre de usuario">

            <label for="avatar-upload">Subir Nuevo Avatar:</label>
            <input type="file" id="avatar-upload" accept="image/*">

            <button id="save-profile">Guardar Cambios</button>
            <button id="back-btn">Volver</button>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Fetch configuration from Netlify Function
        async function getConfig() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Failed to fetch config');
                return await response.json();
            } catch (error) {
                console.error('Error fetching config:', error);
                alert('Error al cargar la configuración. Por favor, intenta de nuevo.');
                throw error;
            }
        }

        // Initialize Firebase and app logic after fetching config
        const CONFIG = await getConfig();
        const firebaseConfig = CONFIG.FIREBASE;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserAvatar = '/default-avatar.png'; // Valor por defecto

        // Elementos DOM
        const displayNameInput = document.getElementById('display-name');
        const avatarUpload = document.getElementById('avatar-upload');
        const saveProfileBtn = document.getElementById('save-profile');
        const backBtn = document.getElementById('back-btn');

        // Estado de autenticación y carga inicial del perfil
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html'; // Redirigir si no está autenticado
            } else {
                currentUser = user;
                console.log('Usuario autenticado:', user.uid);
                await loadUserProfile(user);
            }
        });

        // Cargar perfil del usuario actual
        async function loadUserProfile(user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            console.log('Cargando perfil del usuario:', user.uid);
            if (userSnap.exists()) {
                const data = userSnap.data();
                displayNameInput.value = data.displayName || user.email.split('@')[0] || 'Usuario';
                currentUserAvatar = data.avatarUrl || '/default-avatar.png';
                console.log('Perfil cargado:', { displayName: displayNameInput.value, avatarUrl: currentUserAvatar });
            } else {
                displayNameInput.value = user.email.split('@')[0] || 'Usuario';
                currentUserAvatar = '/default-avatar.png';
                console.log('Perfil no encontrado, usando valores por defecto');
            }
        }

        // Función para subir avatar a Cloudinary
        async function uploadAvatar(file) {
            console.log('Subiendo avatar a Cloudinary...');
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecciona un archivo de imagen.');
                avatarUpload.value = '';
                throw new Error('Archivo no es una imagen');
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('El archivo excede el tamaño máximo de 10 MB.');
                avatarUpload.value = '';
                throw new Error('Archivo demasiado grande');
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CONFIG.CLOUDINARY.uploadPreset);

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.cloudName}/image/upload`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();
            if (data.error) {
                console.error('Error en Cloudinary:', data.error);
                throw new Error(data.error.message || 'Error desconocido al subir la imagen');
            }
            console.log('Avatar subido con éxito:', data.secure_url);
            return data.secure_url;
        }

        // Guardar cambios en el perfil
        saveProfileBtn.addEventListener('click', async () => {
            console.log('Guardando perfil...');
            const displayName = displayNameInput.value.trim();
            const file = avatarUpload.files[0];
            let avatarUrl = currentUserAvatar;

            if (file) {
                try {
                    avatarUrl = await uploadAvatar(file);
                } catch (error) {
                    console.error('Error al subir el avatar:', error.message);
                    alert('Error al subir el avatar: ' + error.message);
                    return;
                }
            }

            const userRef = doc(db, 'users', currentUser.uid);
            try {
                await setDoc(userRef, {
                    displayName: displayName || displayNameInput.value,
                    avatarUrl: avatarUrl,
                    email: currentUser.email,
                }, { merge: true });
                console.log('Perfil guardado con éxito');
                alert('Perfil actualizado correctamente.');
                window.location.href = 'feed.html'; // Redirigir de vuelta al feed
            } catch (error) {
                console.error('Error al guardar en Firebase:', error);
                alert('Error al guardar el perfil: ' + error.message);
            }
        });

        // Botón de volver
        backBtn.addEventListener('click', () => {
            window.location.href = 'feed.html'; // Redirigir al feed
        });
    </script>
</body>
</html>
